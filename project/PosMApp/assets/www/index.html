<!DOCTYPE HTML>
<html>
<head>
	<title>PosMApp</title>
	<link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.4.2.css" />
	<link rel="stylesheet" type="text/css" href="icon.css" />
	<script type="text/javascript" charset="utf-8" src="js/cordova.js"></script>
	<script type="text/javascript" charset="utf-8" src="js/jquery-2.1.1.js"></script>
	<script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.4.2.js"></script>
	<!--<link rel="stylesheet" type="text/css" href="touch-2.3.1/resources/css/sencha-touch.css" />
	<script type="text/javascript" src="touch-2.3.1/sencha-touch-all-debug.js"></script>
	<script type="text/javascript" src="js/app.js"></script>-->
	<script>
		// LocalDBを開く
		var db = openDatabase("PosMAppDB", "", "PosMAppDB", 1000);

		// DBを初期化する
		function initDB() {
			db.transaction(
				function(tr) {
					// テーブルを作成する
					tr.executeSql("DROP TABLE IF EXISTS poster");
					tr.executeSql("DROP TABLE IF EXISTS author");
					tr.executeSql("DROP TABLE IF EXISTS keyword");
					tr.executeSql("CREATE TABLE IF NOT EXISTS poster ( id, sessionid, title, abstract, authorname, authorbelongs )");
					tr.executeSql("CREATE TABLE IF NOT EXISTS author ( id, posterid, name, belongs, first )");
					tr.executeSql("CREATE TABLE IF NOT EXISTS keyword ( id, posterid, keyword )");

					// テーブルを作成に関して制約を含めてちゃんと書いたやつですが、うまく動作しない(furuya)
					/*tr.executeSql("CREATE TABLE IF NOT EXISTS poster ( id INTEGER NOT NULL PRIMARY KEY UNSIGNED AUTO_INCREMENT, sessionid TEXT, title TEXT, abstract TEXT, authorname TEXT, authorbelongs TEXT )");
					tr.executeSql("CREATE TABLE IF NOT EXISTS author ( id INTEGER NOT NULL PRIMARY KEY UNSIGNED AUTO_INCREMENT, posterid INTEGER, name TEXT, belongs TEXT, first INTEGER, FOREIGN KEY (posterid) REFERENCES poster (id) )");
					tr.executeSql("CREATE TABLE IF NOT EXISTS keyword ( id INTEGER NOT NULL PRIMARY KEY UNSIGNED AUTO_INCREMENT, posterid INTEGER, keyword TEXT, FOREIGN KEY (posterid) REFERENCES poster (id) )");*/ 
					
					// 仮データを挿入する (poster)
					tr.executeSql("DELETE FROM poster");
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [1, "A1-1", "ほげほげな発表１", "概要１", "筑波 一郎", "筑波大学"]);
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [2, "A1-2", "ほげほげな発表２", "概要２", "筑波 二郎", "筑波大学"]);
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [3, "A1-3", "ほげほげな発表３", "概要３", "筑波 三郎", "筑波大学"]);
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [4, "A1-4", "ほげほげな発表４", "概要４", "筑波 四郎", "筑波大学"]);
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [5, "A1-5", "ほげほげな発表５", "概要５", "筑波 五郎", "筑波大学"]);
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [6, "A1-6", "ほげほげな発表６", "概要６", "筑波 六郎", "筑波大学"]);
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [7, "A1-7", "ほげほげな発表７", "概要7", "筑波 七郎", "筑波大学"]);
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [8, "A1-8", "ほげほげな発表８", "概要８", "筑波 八郎", "筑波大学"]);
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [9, "A1-9", "ほげほげな発表９", "概要９", "筑波 九郎", "筑波大学"]);
					tr.executeSql("INSERT INTO poster VALUES ( ?, ?, ?, ?, ?, ? )", [10, "A1-10", "ほげほげな発表１０", "概要１０", "筑波 十郎", "筑波大学"]);

					// 仮データを挿入する (author)
					tr.executeSql("DELETE FROM author");
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [1, 1, "筑波 一郎", "筑波大学", 1]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [2, 1, "筑波 一太郎", "筑波大学", 0]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [3, 2, "筑波 二郎", "筑波大学", 1]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [4, 3, "筑波 三郎", "筑波大学", 1]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [5, 4, "筑波 四郎", "筑波大学", 1]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [6, 5, "筑波 五郎", "筑波大学", 1]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [7, 6, "筑波 六郎", "筑波大学", 1]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [8, 7, "筑波 七郎", "筑波大学", 1]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [9, 8, "筑波 八郎", "筑波大学", 1]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [10, 9, "筑波 九郎", "筑波大学", 1]);
					tr.executeSql("INSERT INTO author VALUES ( ?, ?, ?, ?, ? )", [11, 10, "筑波 十郎", "筑波大学", 1]);

					// 仮データを挿入する (keyword)
					tr.executeSql("DELETE FROM keyword");
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [1, 1, "キーワード１"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [2, 1, "キーワード２"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [3, 2, "キーワード３"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [4, 2, "キーワード４"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [5, 3, "キーワード５"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [6, 3, "キーワード６"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [7, 4, "キーワード７"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [8, 5, "キーワード８"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [9, 6, "キーワード９"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [10, 7, "キーワード１０"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [11, 8, "キーワード１１"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [12, 9, "キーワード１２"]);
					tr.executeSql("INSERT INTO keyword VALUES ( ?, ?, ? )", [13, 10, "キーワード１３"]);

				},
				function(err){},
				function(){}
			);
		}
		function showDetailInfoPage() {
			window.location.href = "detail.html";
		}

		function changeBasicInfoPanel(flag) {
			var basicinfopanel = document.getElementById("basicinfopanel");
			if (flag) {
				basicinfopanel.style.display = "inline";
			} else {
				basicinfopanel.style.display = "none";
			}

			var basicinfo = document.getElementById("basicinfo");

			basicinfo.innerHTML = "No. " 
				+ sessionStorage.getItem("posterid")
				+ " ["
				+ sessionStorage.getItem("sessionid")
				+ "]<br />"
				+ sessionStorage.getItem("title")
				+ "<br />発表者： "
				+ sessionStorage.getItem("authorname")
				+ "<br />所属： "
				+ sessionStorage.getItem("authorbelongs");
		}

		function getBasicInfo(icon) {
			// iconのimgタグを取得する
			var image = icon.getElementsByTagName("img")[0];

			// 強調表示されているかどうかで場合分け
			// 画像ファイルの名前で判断している
			if (image.src.indexOf("dpic") != -1) {

				// 基本情報を取得する
				var posterid = Number(image.id.substring(4));
				db.transaction(
					function(tr) {						
						// ポスターの情報を取得する
						tr.executeSql("SELECT * FROM poster WHERE id = ?", [posterid], function(transaction, returnSet){
							if (returnSet.rows.length > 0) {
								var row = returnSet.rows.item(0);

								// (furuya)
								// rowの中に選択したポスターのIDに対応するDB内の基本情報が入っている
								// row.(属性名)で各属性が取り出せる (例:row.titleで発表名)
								console.log(row.title);

								// Session Storageに保存
								sessionStorage.setItem("posterid", posterid);
								sessionStorage.setItem("sessionid", row.sessionid);
								sessionStorage.setItem("title", row.title);
								sessionStorage.setItem("abstract", row.abstract);
								sessionStorage.setItem("authorname", row.authorname);
								sessionStorage.setItem("authorbelongs", row.authorbelongs);
							}
		
						}, function(){});

						// ポスターの発表者一覧を取得する
						tr.executeSql("SELECT * FROM author WHERE posterid = ?", [posterid], function(tr, rs) {
							// 発表者を保存するArray
							var authors = new Array();

							for (var i = 0; i < rs.rows.length; i++) {
								var row = rs.rows.item(i);
								authors.push(row.name);
							}
							console.log(authors);

							// Session Storageに保存
							sessionStorage.setItem("authors", authors);
						}, function(){});

						//　ポスターのキーワード一覧を取得する
						tr.executeSql("SELECT * FROM keyword WHERE posterid = ?", [posterid], function(tr, rs){
							// キーワードを保存するArray
							var keywords = new Array();

							for (var i = 0; i < rs.rows.length; i++) {
								var row = rs.rows.item(i);
								keywords.push(row.keyword);
							}
							console.log(keywords);

							// Session Storageに保存
							sessionStorage.setItem("keywords", keywords);
						}, function(){});
					},
					function(err) {},
					function() {
						changeBasicInfoPanel(true);
					}
				);

				resetIcons();
				image.src = "img/tpic.png";


			} else {
				image.src = "img/dpic.png";
				changeBasicInfoPanel(false);

			}
		}

		function resetIcons() {
			for (var i = 1; i <= 10; i++) {
				var image = document.getElementById("icon" + i);
				image.src = "img/dpic.png";
				changeBasicInfoPanel(false);
			}
		}
	</script>
</head>
<body onload="initDB()">
	<div style="position: relative;">
		<div style="position: absolute;">
			<div align="center">
				<img src="img/postermap.png" border="0" height="100%" width="100%"
				style="
				position: relative;
				z-index: 1;"></img>
			</div>
			<div style="position: relative;">
				<div id="basicinfopanel" style="position: absolute;
				width: 100%;
				height: 100px;
				bottom: 0px;
				display: none;">
					<div id="basicinfo" style="
					position: absolute;
					width: 100%;

			 		text-align: left;
			 		padding: 10px;
			 		
			 		word-break:break-all; 
					margin:0 auto;
			 		background-color: #ffff99;
			 		overflow: hidden;
			 		text-overflow: ellipsis;
			 		z-index: 20;"
			 		onclick="showDetailInfoPage()">

					</div>
					<div style="
					position: absolute;
					top: 0%;
					right: 0px;
					z-index: 30;
					font-size: x-large;
					color: #ff0000;"
					onclick="resetIcons()">
						×
					</div>
				</div>
			</div>
		</div>

		<div style="position: absolute;">
			<div class="vertical" id="iconNo1" onclick="getBasicInfo(this)">
				<img id="icon1" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexver">1</div>

			</div>
			<div class="vertical" id="iconNo2" onclick="getBasicInfo(this)">

				<img id="icon2" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexver">2</div>
			</div>
			<div class="horizontal" id="iconNo3" onclick="getBasicInfo(this)">
				<img id="icon3" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">3</div>

			</div>
			<div class="horizontal" id="iconNo4" onclick="getBasicInfo(this)">
				<img id="icon4" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">4</div>

			</div>
			<div class="horizontal" id="iconNo5" onclick="getBasicInfo(this)">
				<img id="icon5" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">5</div>

			</div>
			<div class="horizontal" id="iconNo6" onclick="getBasicInfo(this)">
				<img id="icon6" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">6</div>

			</div>
			<div class="horizontal" id="iconNo7" onclick="getBasicInfo(this)">
				<img id="icon7" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">7</div>

			</div>
			<div class="horizontal" id="iconNo8" onclick="getBasicInfo(this)">
				<img id="icon8" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">8</div>

			</div>
			<div class="horizontal" id="iconNo9" onclick="getBasicInfo(this)">
				<img id="icon9" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">9</div>

			</div>
			<div class="horizontal" id="iconNo10" onclick="getBasicInfo(this)">
				<img id="icon10" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">10</div>

			</div>


		</div>
	</div>
</body>
</html>
