<!DOCTYPE HTML>
<html>
<head>
	<title>PosMApp</title>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.4.2.min.css" />
	<link rel="stylesheet" type="text/css" href="icon.css" />
	<script type="text/javascript" charset="utf-8" src="js/cordova.js"></script>
	<script type="text/javascript" charset="utf-8" src="js/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.4.2.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="js/initdb.js"></script>

	<script>
		// LocalDBを開く
		var db = openDatabase("PosMAppDB", "", "PosMAppDB", 1000);

		function showDetailInfoPage() {
			window.location.href = "detail.html";
		}

		function changeBasicInfoPanel(flag) {
			var basicinfopanel = document.getElementById("basicinfopanel");
			if (flag) {
				basicinfopanel.style.display = "inline";
			} else {
				basicinfopanel.style.display = "none";
			}

			var basicinfo = document.getElementById("basicinfo");

			basicinfo.innerHTML = "No. " 
				+ sessionStorage.getItem("posterid")
				+ " ["
				+ sessionStorage.getItem("sessionid")
				+ "]<br />"
				+ sessionStorage.getItem("title")
				+ "<br />発表者： "
				+ sessionStorage.getItem("authorname")
				+ "<br />所属： "
				+ sessionStorage.getItem("authorbelongs");
		}

		function init() {
			if (sessionStorage.getItem("posterid") != null) {
				changeBasicInfoPanel(true);
				var iconid = "icon" + sessionStorage.getItem("posterid");
				document.getElementById(iconid).src = "img/tpic.png";
			}

			initDB();
		}

		function getBasicInfo(icon) {
			// iconのimgタグを取得する
			var image = icon.getElementsByTagName("img")[0];

			// 強調表示されているかどうかで場合分け
			// 画像ファイルの名前で判断している
			if (image.src.indexOf("dpic") != -1) {

				// 基本情報を取得する
				var posterid = Number(image.id.substring(4));
				db.transaction(
					function(tr) {						
						// ポスターの情報を取得する
						tr.executeSql("SELECT * FROM poster WHERE id = ?", [posterid], function(transaction, returnSet){
							if (returnSet.rows.length > 0) {
								var row = returnSet.rows.item(0);

								// (furuya)
								// rowの中に選択したポスターのIDに対応するDB内の基本情報が入っている
								// row.(属性名)で各属性が取り出せる (例:row.titleで発表名)
								console.log(row.title);

								// Session Storageに保存
								sessionStorage.setItem("posterid", posterid);
								sessionStorage.setItem("sessionid", row.sessionid);
								sessionStorage.setItem("title", row.title);
								sessionStorage.setItem("abstract", row.abstract);
								sessionStorage.setItem("authorname", row.authorname);
								sessionStorage.setItem("authorbelongs", row.authorbelongs);
							}
		
						}, function(){});

						// ポスターの発表者一覧を取得する
						tr.executeSql("SELECT * FROM author WHERE posterid = ?", [posterid], function(tr, rs) {
							// 発表者を保存するArray
							var authors = new Array();

							for (var i = 0; i < rs.rows.length; i++) {
								var row = rs.rows.item(i);
								authors.push(row.name);
							}
							console.log(authors);

							// Session Storageに保存
							sessionStorage.setItem("authors", authors);
						}, function(){});

						//　ポスターのキーワード一覧を取得する
						tr.executeSql("SELECT * FROM keyword WHERE posterid = ?", [posterid], function(tr, rs){
							// キーワードを保存するArray
							var keywords = new Array();

							for (var i = 0; i < rs.rows.length; i++) {
								var row = rs.rows.item(i);
								keywords.push(row.keyword);
							}
							console.log(keywords);

							// Session Storageに保存
							sessionStorage.setItem("keywords", keywords);
						}, function(){});
					},
					function(err) {},
					function() {
						changeBasicInfoPanel(true);
					}
				);

				resetIcons();
				image.src = "img/tpic.png";


			} else {
				image.src = "img/dpic.png";
				changeBasicInfoPanel(false);

			}
		}

		function resetIcons() {
			for (var i = 1; i <= 10; i++) {
				var image = document.getElementById("icon" + i);
				image.src = "img/dpic.png";
				changeBasicInfoPanel(false);
			}
		}
	</script>
</head>
<body onload="init()">
	<div style="position: relative;">
		<div style="position: absolute;">
			<div align="center">
				<img src="img/postermap.png" border="0" height="100%" width="100%"
				style="
				position: relative;
				z-index: 1;"></img>
			</div>
			<div style="position: relative;">
				<div id="basicinfopanel" style="position: absolute;
				width: 100%;
				height: 100px;
				bottom: 0%;
				display: none;">
					<div id="basicinfo" style="
					position: absolute;
					width: 100%;

			 		text-align: left;
			 		padding: 10px;
			 		
			 		word-break:break-all; 
					margin:0 auto;
			 		background-color: #ffff99;
			 		overflow: hidden;
			 		text-overflow: ellipsis;
			 		z-index: 20;"
			 		onclick="showDetailInfoPage()">

					</div>
					<div style="
					position: absolute;
					top: 0%;
					right: 0px;
					z-index: 30;
					font-size: 40px;
					color: #ff0000;"
					onclick="resetIcons()">
						×
					</div>
				</div>
			</div>
		</div>

		<div style="position: absolute;">
			<div class="vertical" id="iconNo1" onclick="getBasicInfo(this)">
				<img id="icon1" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexver">1</div>

			</div>
			<div class="vertical" id="iconNo2" onclick="getBasicInfo(this)">

				<img id="icon2" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexver">2</div>
			</div>
			<div class="horizontal" id="iconNo3" onclick="getBasicInfo(this)">
				<img id="icon3" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">3</div>

			</div>
			<div class="horizontal" id="iconNo4" onclick="getBasicInfo(this)">
				<img id="icon4" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">4</div>

			</div>
			<div class="horizontal" id="iconNo5" onclick="getBasicInfo(this)">
				<img id="icon5" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">5</div>

			</div>
			<div class="horizontal" id="iconNo6" onclick="getBasicInfo(this)">
				<img id="icon6" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">6</div>

			</div>
			<div class="horizontal" id="iconNo7" onclick="getBasicInfo(this)">
				<img id="icon7" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">7</div>

			</div>
			<div class="horizontal" id="iconNo8" onclick="getBasicInfo(this)">
				<img id="icon8" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">8</div>

			</div>
			<div class="horizontal" id="iconNo9" onclick="getBasicInfo(this)">
				<img id="icon9" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">9</div>

			</div>
			<div class="horizontal" id="iconNo10" onclick="getBasicInfo(this)">
				<img id="icon10" src="img/dpic.png" width="100%" height="100%"></img>
				<div class="iconindexhor">10</div>

			</div>


		</div>
	</div>
</body>
</html>
